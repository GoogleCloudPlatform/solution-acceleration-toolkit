templates:
- name: "project"
  recipe_path: "../folder/project.yaml"

- name: "data_dir"
  output_ref: "project.dir"
  output_path: "./data"

- name: "terraform"
  recipe_path: "../terraform/terraform.yaml"
  output_ref: "data_dir"
  data:
    VARS:
    - NAME: "project_id"
      TYPE: "string"
    {{if get . "STORAGE_BUCKETS"}}
    - NAME: "storage_location"
      TYPE: "string"
      VALUE: '"{{.STORAGE_LOCATION}}"'
    {{end}}
    DEPS:
    - NAME: "project"
      PATH: "../project"
      MOCK_OUTPUTS:
        project_id: '"mock-project"'
    INPUTS:
      project_id: "dependency.project.outputs.project_id"

{{range $i, $_ := get . "STORAGE_BUCKETS"}}
- name: "bucket-{{.NAME}}"
  component_path: "../../components/project/storage"
  output_ref: "data_dir"
  flatten:
  - key: "STORAGE_BUCKETS"
    index: {{$i}}
{{end}}
