# Terraform Engine Template Development Guide

This document provides some tips and guidances for Terraform Engine template
developers.

## Config and Syntax

1. Terraform Engine uses [go templating](https://golang.org/pkg/text/template/)
    under the hood.

1. Use `$` to escape `$` in the Terraform Engine templates.
    ([example](https://github.com/GoogleCloudPlatform/healthcare-data-protection-suite/blob/cf04e009d21974b1ad5e5fdccef4077e7869bdb0/examples/tfengine/modules/team.hcl#L68))

1. Use dot (`.`) to obtain mandatory map fields, e.g. `{{.name}}`.

1. Use `get` function to obtain optional map fields, e.g. `{{get . "exists"
    false}}`. The last argument is the default value to return when the field
    cannot be found in the map.

1. Use `range` function to iterate over a list, e.g.

    ```hcl
    {{range $_, $env := .envs -}}
    template "env" {
      recipe_path = "./env.hcl"
      output_path = "./{{$env}}"
      data = {
        env = "{{$env}}"
      }
    }
    {{end}}
    ```

1. Check out more available default functions
    [here](https://golang.org/pkg/text/template/#hdr-Functions) and custom
    functions
    [here](https://github.com/GoogleCloudPlatform/healthcare-data-protection-suite/blob/master/internal/template/funcmap.go).

1. When Terraform Engine generates Terraform configs from templates, if the
    `resource_name` field is not specified for a resource
    ([example](https://github.com/GoogleCloudPlatform/healthcare-data-protection-suite/blob/cf04e009d21974b1ad5e5fdccef4077e7869bdb0/examples/tfengine/modules/foundation.hcl#L46)),
    then the underlying Terraform module or Terraform resource in the generated
    Terraform configs will be automatically named from the resource's uniqie
    identifier (bucket's name, network's name, group's id, etc)
    ([example](https://github.com/GoogleCloudPlatform/healthcare-data-protection-suite/blob/cf04e009d21974b1ad5e5fdccef4077e7869bdb0/examples/tfengine/generated/team/groups/main.tf#L43)).
    All non-alphanumeric characters will be converted to `_`, such as `-`, `.`,
    and `@`.

1. Members in
    [iam_members](https://github.com/GoogleCloudPlatform/healthcare-data-protection-suite/blob/cf04e009d21974b1ad5e5fdccef4077e7869bdb0/examples/tfengine/modules/team.hcl#L231)
    component do not support referencing calculated values/attributes from other
    resources due to an underlying module
    [limitation](https://github.com/terraform-google-modules/terraform-google-iam#referencing-valuesattributes-from-other-resources).
    A common example is referencing the `email` of a service account created in
    the same deployment in an `iam_members` resource. To work around this
    limitation, referencing the service account via
    `$${google_service_account.myserviceaccount.account_id}@myproject.iam.gserviceaccount.com`
    instead of `$${google_service_account.myserviceaccount.email}` as the
    `account_id` is not a calculated value.
    ([example](https://github.com/GoogleCloudPlatform/healthcare-data-protection-suite/blob/cf04e009d21974b1ad5e5fdccef4077e7869bdb0/examples/tfengine/modules/team.hcl#L234))

1. When writing raw Terraform configs, use `for_each` to group similar
    resources.

1. For large block of raw Terraform configs, instead of using the
    `terraform_addons.raw_config` block with in a `template` block, consider
    using a separate `template` block to generate a seperate `.tf` file from a
    template file, e.g. Do not name the `.tf` file `main.tf` as it will conflict
    with the default `main.tf` file generated by the Terraform Engine.

    ```hcl
    template "terraform_deployment" {
      component_path = "./foo.tf.tmpl"
      output_path = "./foo.tf"
      data = {
        ...
      }
    }
    ```

1. Data blocks in templates follow a Tree structure. Values in the `data` block
    from an upper level template are passed down to its child templates and made
    available. There is no need to repeat those values in the `data` block in
    child templates unless you would like to override them. For example, all
    values specified in the top level template
    [here](https://github.com/GoogleCloudPlatform/healthcare-data-protection-suite/blob/cf04e009d21974b1ad5e5fdccef4077e7869bdb0/examples/tfengine/team.hcl#L17)
    are passed down and made available to child templates
    [foundation.hcl](https://github.com/GoogleCloudPlatform/healthcare-data-protection-suite/blob/cf04e009d21974b1ad5e5fdccef4077e7869bdb0/examples/tfengine/modules/foundation.hcl)
    and
    [team.hcl](https://github.com/GoogleCloudPlatform/healthcare-data-protection-suite/blob/cf04e009d21974b1ad5e5fdccef4077e7869bdb0/examples/tfengine/modules/team.hcl).

## Formatting

1. `terraform fmt` is run by default as part of the `tfengine` command
    execution.

1. There is no good formatting tools for `.hcl` files. You can use use the
    `hclfmt` command from [terragrunt](https://terragrunt.gruntwork.io/) tool
    but it does not always work.

1. `{{- ...}}` and `{{... -}}` can be used to remove empty lines before or
    after the current block in the generated configs.

## Terraform Engine Execution

1. When the Terraform Engine template is invalid and the `terraform fmt` step
    run as part of the `tfengine` command will fail, so the output won't get
    copied over to the output directory. To help debug, pass `--format=false` to
    the `tfengine` command and then see the broken file, fix it and then re-run
    the `tfengine` command with `--format=true`.

1. By default, if you generated a file and then updated your Terraform Engine
    template to remove the file, `tfengine` won't remove it from the output
    directory. To delete those unmanaged files, use `--delete_unmanaged_files`
    in the `tfengine` command.
